# 基于 Agent Skills 的 AI 记忆系统解决方案

> **目标**: 用 Agent Skills 技术解决 AI 会话失忆、上下文腐烂、经验孤岛问题

---

## 一、问题与需求对应

| 核心问题 | 真实需求 | Agent Skills 如何解决 |
|---------|---------|---------------------|
| **会话失忆症** - 每次对话从零开始 | **长效持久记忆** - 跨会话衔接工作 | 将用户身份、项目背景、工作进度存入技能文件，新会话自动加载 |
| **上下文腐烂** - 长对话注意力分散 | **按需加载** - 仅加载相关信息 | 利用渐进式披露，只在任务触发时加载对应技能 |
| **经验孤岛** - 成功经验无法跨项目 | **经验无感沉淀** - 自动提取高价值内容 | 任务结束后自动将成功路径写入全局技能文件 |

---

## 二、解决方案架构

```
┌─────────────────────────────────────────────────────────┐
│                     用户交互层                           │
│                                                         │
│  用户发起任务 → AI 识别意图 → 匹配相关技能 → 执行任务    │
└─────────────────────────────────────────────────────────┘
                            ↓ ↑
┌─────────────────────────────────────────────────────────┐
│                   渐进式加载机制                         │
│                                                         │
│  Level 1: 扫描所有技能的 name + description (~100 tokens)│
│  Level 2: 加载匹配技能的完整指令                         │
│  Level 3: 按需加载脚本/参考资料                          │
└─────────────────────────────────────────────────────────┘
                            ↓ ↑
┌─────────────────────────────────────────────────────────┐
│                     技能存储层                           │
│                                                         │
│  全局技能 (~/.gemini/antigravity/skills/)    项目技能 (.agent/skills/) │
│  ├── user-profile/              ├── project-context/    │
│  ├── coding-patterns/           ├── business-rules/     │
│  └── problem-solutions/         └── local-workflows/    │
└─────────────────────────────────────────────────────────┘
                            ↓ ↑
┌─────────────────────────────────────────────────────────┐
│                   经验沉淀机制                           │
│                                                         │
│  任务完成 → 识别高价值内容 → 更新/创建技能文件 → 去重合并  │
└─────────────────────────────────────────────────────────┘
```

---

## 三、需求一：长效持久记忆

### 问题
- 新会话不知道用户是谁
- 不记得之前的项目结构
- 忘记已经做过的决策

### 解决方案：用户档案技能

在 `~/.gemini/antigravity/skills/user-profile/SKILL.md` 存储：

```yaml
---
name: user-profile
description: |
  用户个人档案，包含身份信息、偏好设置、常用项目。
  每次新会话开始时自动激活。
---

# 用户档案

## 基本信息
- 用户名: lanstar
- 系统: macOS (256GB 存储空间，需节省磁盘)
- 常用语言: 中文
- 代码风格: 简洁实用

## 偏好设置
- 不要全局安装 (npm -g, pip)
- 优先使用本地依赖
- 错误后停止，不自动重试

## 活跃项目
1. 懒爱瘦 - 减肥产品 Android + Web + Server
2. 智剪大师 - 视频剪辑软件
```

### 实现效果
- 新会话自动识别用户
- 自动应用用户偏好
- 知道用户正在做什么项目

---

## 四、需求二：按需加载与进化

### 问题
- 所有信息一次性加载会撑爆上下文
- 无关信息干扰决策
- 知识不能自我更新

### 解决方案：分层技能库

```
~/.gemini/antigravity/skills/
├── user-profile/          # Level 1: 每次都加载
│   └── SKILL.md
├── coding-patterns/       # Level 2: 写代码时加载
│   └── SKILL.md
├── debug-solutions/       # Level 2: 调试时加载
│   └── SKILL.md
└── domain-knowledge/      # Level 3: 特定领域时加载
    ├── android-tips/
    ├── firebase-patterns/
    └── nodejs-server/
```

### 渐进式披露运作方式

1. **启动时**: 只扫描每个技能的 `description` (~100 tokens/技能)
2. **任务匹配**: 根据用户请求匹配相关技能
3. **按需激活**: 只加载匹配的技能完整内容
4. **深度加载**: 只在需要时读取 `scripts/` 内的资源

### 进化机制

每次成功解决问题后：

```
1. AI 识别成功路径
2. 检查是否已有相似技能
   ├── 有 → 合并更新
   └── 无 → 创建新技能
3. 去重：相似内容合并为一条
```

---

## 五、需求三：经验无感沉淀

### 问题
- 解决 Bug 的过程没有记录
- 下次遇到同样问题还是从头来
- 需要用户手动整理太麻烦

### 解决方案：任务后自动沉淀

当任务成功完成时，触发沉淀流程：

```
┌─────────────────────────────────────────────┐
│               自动沉淀判断                   │
│                                             │
│  1. 任务是否成功完成？                        │
│  2. 过程中是否有试错/调试？                   │
│  3. 解决方案是否有复用价值？                  │
│                                             │
│  如果满足条件 → 提取关键步骤 → 存入技能文件    │
└─────────────────────────────────────────────┘
```

### 沉淀内容示例

假设刚解决了一个 Firebase 登录问题：

```yaml
---
name: firebase-mobile-login-fix
description: |
  Firebase Google 登录在移动端失败的解决方案。
  当遇到移动端登录问题时激活。
---

# Firebase 移动端登录问题

## 问题现象
- 桌面端正常
- 移动端点击后返回登录页，无错误提示

## 根因
- 移动端浏览器对 popup 限制更严格
- 需要使用 redirect 方式

## 解决步骤
1. 将 signInWithPopup 改为 signInWithRedirect
2. 添加 getRedirectResult 处理回调
3. 确保 OAuth 配置包含移动端域名

## 相关文件
- src/components/LoginPage.tsx
```

---

## 六、实施路径

### 第一步：建立基础结构
```bash
mkdir -p ~/.gemini/antigravity/skills/user-profile
mkdir -p ~/.gemini/antigravity/skills/problem-solutions
```

### 第二步：创建用户档案技能
存储用户基本信息和偏好

### 第三步：手动沉淀几个经验
先手动创建几个技能，验证机制

### 第四步：启用 AI 自主沉淀机制

AI 根据评价体系自主判断是否需要沉淀，用户只需确认或拒绝。

---

## 七、AI 沉淀评价体系

AI 在任务结束时自动评估，根据以下标准判断是否建议沉淀：

### 7.1 沉淀触发条件（满足任意一条即触发）

| 条件 | 说明 | 优先级 |
|-----|------|-------|
| **经历试错** | 任务过程中有失败→调整→成功的过程 | 高 |
| **调试耗时** | 解决问题花费了多个来回 | 高 |
| **非常规解法** | 使用了项目特有的方案或变通方法 | 中 |
| **业务规则** | 涉及到业务逻辑、特殊约定 | 中 |
| **用户主动要求** | 用户说"记住这个"、"以后都这样做" | 最高 |

### 7.2 不沉淀条件（满足任意一条则不沉淀）

| 条件 | 说明 |
|-----|------|
| **一次成功** | 直接成功，无试错过程，说明是常规操作 |
| **临时性操作** | 明确只是这一次的特殊处理 |
| **敏感信息** | 包含密码、密钥、个人隐私 |
| **已有相同技能** | 完全重复的内容 |

### 7.3 沉淀流程

```
┌─────────────────────────────────────────────────────────┐
│                   任务结束                              │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│            AI 自动评估（用户无感知）                      │
│                                                         │
│  1. 检查是否满足沉淀触发条件                              │
│  2. 检查是否命中不沉淀条件                               │
│  3. 计算沉淀价值分数                                     │
└─────────────────────────────────────────────────────────┘
                        ↓
              ┌─────────────────┐
              │  分数 >= 阈值?   │
              └─────────────────┘
               ↓是            ↓否
┌──────────────────────┐    ┌──────────────────────┐
│  向用户提议沉淀        │    │  静默结束，不打扰用户  │
│                      │    │                      │
│  "建议将这次解决      │    └──────────────────────┘
│   移动端登录问题的     │
│   方案保存为技能，     │
│   方便下次复用。       │
│   是否确认？"         │
└──────────────────────┘
          ↓
    ┌───────────────┐
    │  用户确认?     │
    └───────────────┘
     ↓是          ↓否
┌──────────┐   ┌──────────┐
│ 创建/更新 │   │ 不保存   │
│ 技能文件  │   └──────────┘
└──────────┘
```

### 7.4 用户主动触发

用户也可以随时主动要求沉淀：
- "把这个方案记下来"
- "以后遇到这种问题都这样处理"
- "总结一下我们刚才的解决过程"

---


## 八、核心基础设施：检索对比引擎

所有高级功能都依赖一个核心能力：**沉淀前检索对比**。

### 8.1 实现原理：利用渐进式披露

**核心思路**：利用 Agent Skills 的渐进式披露机制，只对比 description，无需额外基础设施。

```
沉淀新知识时：
├── AI 为新知识生成 description（问题摘要 + 场景描述）
├── 扫描现有所有技能的 description（~100 tokens/个）
├── AI 直接对比 description 之间的语义相似度
└── 判断是否重复/相似/新知识
```

**优点**：
- ✅ 不需要向量数据库
- ✅ 不需要额外基础设施
- ✅ AI 原生语言理解能力就能完成
- ✅ 与 Agent Skills 机制完全一致

### 8.2 对比流程

```
┌─────────────────────────────────────────────────────────┐
│                 新知识准备沉淀                           │
│                                                         │
│  AI 生成 description: "Firebase Google 登录在移动端     │
│  失败的解决方案，当遇到移动端登录问题时激活"             │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              扫描现有技能 description                    │
│                                                         │
│  - "用户个人档案..." → 不相关                           │
│  - "Firebase 初始化配置..." → 40% 相似                  │
│  - "Google OAuth 移动端问题..." → 85% 相似 ⚠️           │
└─────────────────────────────────────────────────────────┘
                        ↓
              ┌─────────────────┐
              │  有高相似技能?   │
              └─────────────────┘
          ↓无                  ↓有
    ┌──────────┐      ┌──────────────────────┐
    │ 创建新技能 │      │ AI 判断：             │
    └──────────┘      │ - 完全相同 → 跳过      │
                      │ - 部分相似 → 合并更新  │
                      │ - 内容过时 → 替换更新  │
                      └──────────────────────┘
```

---

## 九、问题解决方案

### 9.1 阈值自动进化（解决"太频繁/太少"问题）

**核心思路**：冷启动低阈值 → 根据反馈自动调整

```
┌─────────────────────────────────────────────────────────┐
│                    阈值进化机制                          │
└─────────────────────────────────────────────────────────┘

初期（技能库 < 10 个）:
├── 阈值 = 低
├── 多提议沉淀，鼓励积累
└── 即使是普通成功也可能提议

中期（技能库 10-50 个）:
├── 阈值 = 中
├── 根据用户确认率调整
│   ├── 确认率 > 80% → 阈值可适当降低
│   └── 确认率 < 30% → 阈值应提高
└── 检索对比开始发挥去重作用

稳定期（技能库 > 50 个）:
├── 阈值 = 高
├── 只有真正高价值内容才提议
└── 检索对比成为主要过滤手段（大部分新知识已有类似技能）
```

**自动调整公式**:
```
下次阈值 = 当前阈值 × (1 - 调整系数 × (实际确认率 - 目标确认率))

目标确认率 = 60%（提议10次用户确认6次为最佳）
调整系数 = 0.1（缓慢调整，避免震荡）
```

### 9.2 去重合并（解决"重复技能"问题）

利用 8.1 的检索对比功能：

| 相似度 | 判断 | 操作 |
|-------|------|------|
| > 90% | 完全相同 | 跳过，不保存 |
| 70-90% | 高度相似 | 询问用户是否合并到已有技能 |
| 40-70% | 部分相关 | 作为已有技能的补充段落 |
| < 40% | 新知识 | 创建新技能文件 |

### 9.3 进化更新（解决"技能过时"问题）

**过时检测触发条件**:

| 条件 | 说明 |
|-----|------|
| **执行失败** | 按技能步骤执行但失败了 |
| **用户纠正** | 用户说"不对，现在要这样做" |
| **新方案冲突** | 新沉淀的知识与旧技能矛盾 |

**更新流程**:
```
检测到过时信号
      ↓
AI 生成更新建议
      ↓
向用户发送更新请求：
"技能 [firebase-login-fix] 可能已过时，
 建议更新为：[新内容摘要]
 是否确认更新？"
      ↓
用户确认 → 自动更新技能文件
```

### 9.4 隐私处理（解决"敏感信息"问题）

**方案**：采用类似 `.env` 的环境变量引用机制

**1. 创建敏感信息配置文件**:
```bash
# ~/.gemini/secrets.env (不加入版本控制)
# 使用自然语言格式，用户随意书写
小米路由器IP：192.168.31.1
SSH密码：your_password
Firebase项目ID：my-project-123
腾讯云服务器：1.2.3.4，密码是abc123
```

**2. 技能文件中引用变量**:
```yaml
---
name: xiaomi-shellclash-update
description: 更新小米路由器节点配置
requires_config: true
---

## 环境要求
本技能需要以下配置（从 ~/.gemini/secrets.env 读取）：
- 小米路由器 IP
- SSH 密码

## 执行步骤
1. SSH 连接 ${小米路由器IP}，密码 ${SSH密码}
...
```

**3. AI 加载时自动理解**:
- 读取 `~/.gemini/secrets.env`
- 从自然语言中提取所需信息
- 敏感值不会被写入技能文件本身

**4. 好处**:
- 用户无需学习特定格式
- 技能文件可以安全分享/备份
- 敏感信息集中管理
- 迁移到新电脑只需复制 secrets.env

---

## 十、完整架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户交互层                                │
│                                                                 │
│   用户任务 ←→ AI 执行 ←→ 任务完成                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                      渐进式加载机制                              │
│                                                                 │
│   Level 1: 扫描所有技能描述 → Level 2: 激活相关技能               │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                       技能存储层                                 │
│                                                                 │
│   ~/.gemini/                                                    │
│   ├── skills/              # 技能文件库                          │
│   │   ├── user-profile/                                         │
│   │   ├── problem-solutions/                                    │
│   │   └── domain-knowledge/                                     │
│   ├── secrets.env          # 敏感信息（环境变量）                  │
│   └── meta.json            # 元数据（阈值、统计）                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                     智能沉淀引擎                                 │
│                                                                 │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐          │
│   │ 检索对比引擎 │ → │ 阈值进化器  │ → │ 用户确认 UI │          │
│   └─────────────┘   └─────────────┘   └─────────────┘          │
│          ↓                                                      │
│   ┌─────────────┐   ┌─────────────┐                            │
│   │ 去重/合并器 │   │ 过时检测器  │                            │
│   └─────────────┘   └─────────────┘                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 十、补充说明

### 10.1 技能分类策略

技能可以按文件夹分类组织，但**分类不限制 AI 搜索范围**：

```
~/.gemini/antigravity/skills/
├── android/                    # 分类只是文件夹组织
│   └── firebase-login-fix/
│       └── SKILL.md
├── nodejs/
│   └── pm2-deployment/
│       └── SKILL.md
└── general/
    └── git-workflow/
        └── SKILL.md
```

**关键原则**：
- ✅ AI 扫描时仍然检查所有分类下的所有 description
- ✅ 分类只帮助用户手动管理、备份、浏览
- ✅ 不会因为分类错误导致 AI 找不到技能

### 10.2 幻觉风险缓解

防止 AI 将错误知识沉淀到技能库：

**已有机制**：
- ✅ 用户确认环节（可以拒绝错误沉淀）
- ✅ 过时检测（执行失败时触发更新）

**补充措施**：

1. **置信度标记**：在技能文件中标注来源
```yaml
---
name: firebase-login-fix
description: ...
source: 实际调试验证    # 或 "文档推断"、"网络搜索"
confidence: high        # high / medium / low
last_verified: 2026-01-16
---
```

2. **定期审计提醒**：每使用 N 次后提醒用户复核
```
"技能 [firebase-login-fix] 已使用 10 次，
 建议检查内容是否仍然准确。"
```

### 10.3 敏感信息保护

**规则**：AI 不应将 `secrets.env` 中的实际值写入技能文件。

在用户规则（如 `~/.gemini/GEMINI.md`）中添加：
```
禁止将 secrets.env 中的实际值写入任何技能文件。
技能文件中只能使用 ${VAR_NAME} 形式引用。
```

---

## 十一、总结

| 需求 | 实现方式 | 关键组件 |
|-----|---------|---------|
| 长效持久记忆 | 用户档案技能 | `user-profile/SKILL.md` |
| 按需加载 | 渐进式披露 | 三级加载机制 |
| 经验无感沉淀 | AI 自主判断 + 用户确认 | 沉淀评价体系 |
| 智能阈值 | 冷启动低阈值 → 自动进化 | 确认率反馈调整 |
| 去重合并 | 沉淀前检索对比 | 语义相似度匹配 |
| 知识进化 | 执行失败/用户纠正触发 | 过时检测 + 更新提议 |
| 隐私安全 | 环境变量引用 | `secrets.env` + `${VAR}` 替换 |
| 幻觉防护 | 置信度标记 + 定期审计 | source / confidence 字段 |
| 技能管理 | 文件夹分类（不限制搜索） | 人类组织 + AI 全库扫描 |
