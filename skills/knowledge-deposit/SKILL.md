---
name: knowledge-deposit
description: |
  经验沉淀技能。在任务成功完成后，评估是否需要将解决方案保存为可复用的技能。
  触发条件：任务结束时、用户说"记住这个"/"保存这个"、解决问题过程有试错。
  用于指导 AI 如何正确地将知识沉淀为技能文件。
compatibility: Claude Code, Gemini CLI, OpenAI Codex, iFlow CLI
metadata:
  author: lanstar128
  version: "1.0"
---

# 经验沉淀技能

本技能指导 AI 在任务完成后，将有价值的解决方案沉淀为可复用的技能文件。

---

## 一、沉淀评估

### 1.1 触发沉淀的条件（满足任意一条）

| 条件 | 检测方式 |
|-----|---------|
| 经历试错 | 任务过程中有失败→调整→成功 |
| 调试耗时 | 对话来回超过 5 轮 |
| 非常规解法 | 使用了项目特有的方案或变通方法 |
| 用户主动要求 | 用户说"记住这个"、"保存"、"以后都这样做" |

### 1.2 不沉淀的条件（满足任意一条则跳过）

| 条件 | 说明 |
|-----|------|
| 一次成功 | 直接成功，无试错，说明是常规操作 |
| 临时操作 | 明确只是这一次的特殊处理 |
| 敏感信息 | 包含密码、密钥、个人隐私 |
| 已有技能 | 检索后发现已存在相同技能 |

---

## 二、信息提取

从对话中提取以下信息：

```
问题描述: [用一句话描述遇到的问题]
问题现象: [具体表现是什么]
根因分析: [为什么会出现这个问题]
解决步骤:
  1. [第一步]
  2. [第二步]
  ...
相关文件: [涉及的文件路径]
关键代码: [如有必要，记录核心代码片段]
```

---

## 三、检索对比

在创建新技能前，必须检索现有技能库。

### 3.1 确定技能根目录

AI 应根据当前运行环境确定技能根目录 (`SKILL_ROOT`)：

| 环境 | 根目录路径 |
|------|-----------|
| **Antigravity** | `~/.gemini/antigravity/skills/` |
| **Gemini CLI** | `~/.gemini/skills/` |
| **Claude Code** | `~/.claude/skills/` |
| **Codex CLI** | `~/.codex/skills/` |
| **iFlow CLI** | `~/.iflow/skills/` |

> 如果无法确定环境，默认尝试 `~/.gemini/skills/` 和 `~/.claude/skills/`。

### 3.2 检索步骤

1. 列出 `${SKILL_ROOT}` 目录
2. 读取每个子目录中的 `SKILL.md` 文件的 YAML 头部（只需 `description` 字段）
3. 对比新知识的描述与现有技能的 `description`

### 3.3 判断逻辑

| 情况 | 操作 |
|-----|------|
| 找到高度相似的技能 | 询问用户是否更新该技能 |
| 找到部分相关的技能 | 询问用户是否作为补充添加 |
| 无相关技能 | 创建新技能 |

---

## 四、用户确认

在执行沉淀前，必须向用户确认：

```
建议将这次解决 [问题描述] 的方案保存为技能。

技能名称: [建议的名称]
保存位置: ${SKILL_ROOT}/[技能名称]/

摘要:
- 问题: [简述]
- 解决: [简述]

是否确认保存？
```

用户确认后才能创建文件。用户拒绝则静默结束。

---

## 五、创建技能文件

### 5.1 命名规则

- 从问题描述提取 2-4 个关键词
- 用连字符连接
- 全小写
- 示例: `firebase-mobile-login-fix`, `pm2-deployment-workflow`

### 5.2 文件结构

```
${SKILL_ROOT}/[技能名称]/
└── SKILL.md
```

### 5.3 SKILL.md 模板

```yaml
---
name: [技能名称]
description: |
  [一两句话描述问题和解决场景]
  [说明什么情况下应该激活这个技能]
source: 实际调试验证
confidence: high
last_verified: [当前日期 YYYY-MM-DD]
---

# [问题标题]

## 问题现象
[描述问题的表现]

## 根因
[分析问题产生的原因]

## 解决步骤
1. [步骤一]
2. [步骤二]
3. ...

## 相关文件
- [文件路径1]
- [文件路径2]

## 注意事项
- [需要注意的点]
```

---

## 六、完成输出

创建成功后，输出：

```
✅ 技能已保存

位置: ${SKILL_ROOT}/[技能名称]/SKILL.md
下次遇到类似问题时会自动激活此技能。
```

---

## 七、特殊情况处理

### 7.1 用户要求保存到项目级

如果用户明确说"只在这个项目使用"，则保存到：
```
<当前工作区>/.agent/skills/[技能名称]/SKILL.md
```

### 7.2 配置信息处理

技能分为两类：**需要配置信息** 和 **不需要配置信息**。

#### 不需要配置的技能

纯知识类技能，不涉及密码、IP、密钥等，直接写内容即可。

示例（代码调试技巧）：
```yaml
---
name: react-usestate-fix
description: React useState 更新不生效的解决方案
---
# 直接写解决步骤，无需配置
```

#### 需要配置的技能

涉及密码、IP、密钥等敏感信息或环境变量的技能。

**写法规范**：
1. 在 YAML 头部添加 `requires_config: true`
2. 在正文开头添加"环境要求"章节，列出需要的配置
3. 使用 `${描述}` 引用配置值

示例：
```yaml
---
name: xiaomi-shellclash-update
description: 更新小米路由器 ShellClash 节点配置
requires_config: true
---

## 环境要求
本技能需要以下配置（从 ~/.gemini/secrets.env 读取）：
- 小米路由器 IP
- SSH 密码

## 执行步骤
1. SSH 连接 ${小米路由器IP}，密码 ${SSH密码}
...
```

### 7.3 配置提醒流程

创建需要配置的技能时，必须执行以下流程：

```
┌─────────────────────────────────────────────────────────┐
│                 技能创建完成后                           │
└─────────────────────────────────────────────────────────┘
                        ↓
              ┌─────────────────┐
              │ 技能需要配置?   │
              └─────────────────┘
           ↓否                  ↓是
    ┌──────────┐      ┌──────────────────────────────────┐
    │ 直接结束  │      │ 检查 ~/.gemini/secrets.env       │
    └──────────┘      │ 是否已有所需配置                  │
                      └──────────────────────────────────┘
                                  ↓
                        ┌─────────────────┐
                        │  配置已存在?    │
                        └─────────────────┘
                     ↓是                  ↓否
              ┌──────────┐      ┌──────────────────────────┐
              │ 直接结束  │      │ 提醒用户添加配置          │
              └──────────┘      └──────────────────────────┘
```

### 7.4 提醒用户添加配置

当技能需要的配置不存在时，输出：

```
⚠️ 此技能需要配置信息

请在 ~/.gemini/secrets.env 中添加以下内容（用你习惯的方式写即可）：

示例：
小米路由器IP：192.168.31.1
SSH密码：你的密码

添加后，下次执行此技能时会自动读取。
```

**关键点**：
- 告诉用户**需要添加什么**（具体的配置项名称）
- 给出**示例格式**（让用户知道怎么写）
- 说明**用自然语言写即可**（降低用户心理负担）


